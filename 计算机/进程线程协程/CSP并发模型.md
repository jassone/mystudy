## CSP并发模型
CSP（Communicating Sequential Process）并发模型，随着Go语言的逐渐走红，也更多地被程序员所谈论。

计算机科学中，**CSP是一种描述并发性系统之间进行交互的模型，其交互模式是通过管道(channel)进行消息传递。**

什么是管道，两个并发任务不需要共享内存，而是通过建立一条点对点的管道，数据用完之后，管道立即撤销。有了管道，不需要事先锁，而是需要用数据时建立管道。不需要数据时就撤销管道了。

管道与共享内存之间有很大的区别，内存共享是通过内存来共享内存，而管道是通过通信来共享内存。所以管道通信比内存共享效率要高很多。

Go语言借鉴了CSP模型的理论，使用goroutine（一种运行在用户态的协程）和在goroutine之间收发消息的channel实现了高效并发。

## 一、几种并发编程模型
### 1、多线程
提起并发编程，最常见的就是多线程编程。线程是操作系统能够进行调度的最小单位，共享同一进程的数据和资源，有内核线程和用户线程之分，由操作系统或用户进程调度。多线程的程序可以利用多核CPU，并行地处理多个任务。随着并发量增大，线程数增加，多线程的并发模型面临一些问题。

##### 内存占用
64位JVM线程默认栈空间是1M，启动1024个线程理论上消耗1G的栈空间。由于线程需要内存较多，为避免内存耗尽，应用程序不应该大量创建线程。

##### 线程调度
操作系统对线程进行调度也需要成本。线程挂起前会保存线程上下文到栈空间，再切换到可执行线程。线程数很多时，线程上下文切换会导致CPU开销变大。

使用线程池技术可以对多线程并发进行优化，线程池实现线程复用，避免频繁创建新线程和线程切换，控制了线程数量，减少了内存的消耗。但是在竞争共享数据的时候，需要用加锁来保护共享数据，这样也降低了程序的并发效率。

##### 异步回调
为了充分利用CPU，不让线程空等待，在线程阻塞的时候，注册一个回调方法，让当前线程不再阻塞，去处理新的请求。等结果准备好，调度器把结果传给回调方法，在回调方法中继续处理结果。然而回调方法并不在发起请求的线程里执行。

异步回调的缺点是所谓的callback hell。原本顺序同步的执行逻辑拆分到回调方法中，而且回调方法中可能再嵌套回调方法。这种写程序的方式还是让很多程序员不太习惯。异步回调的典型实现是NodeJS，目前也有一些第三方模块将异步代码同步化。

### 2、协程（纤程）
协程（纤程）也是一种异步方案。在代码IO阻塞时，当前协程让出CPU执行权，让其它协程执行。待IO操作完毕，阻塞的协程继续执行。虽然代码是异步执行，但写代码看起来像是同步的。协程是用户态的轻量级线程，现在的机器可以启动百万数量的协程。支持协程的编程语言实现了协程的调度器，提供了channel机制进行协程间通信（CSP模型中消息传递的实现）。基于CSP模型的协程方案，实现了无共享内存无锁的并发，可以匹配异步回调的性能。

coroutine就是协程，也称为go程。通过管道能够实现百万级的并发。如果说**线程是抢占式的，那么协程是协作式的。**在协程里面，也是通过管道来调度的。解放线程对CPU和内存的开销，线程是先占用CPU和内存后才调度，而协程是通过通信发送信号来调度，协程全是通过管道，由于协程的消耗比线程小很多，所以能够实现百万并发。

在协程中，IO操作时绝大部分时间与CPU无关，这是管道带来的优势，不需要长时间锁住内存，也不需要CPU来做调度。