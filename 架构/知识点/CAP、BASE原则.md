## CAP/BASE 定理
## 一、CAP 定理
### 1、什么是 CAP 定理
2000 年的时候，Eric Brewer 教授提出了 CAP 猜想，2年后，被 Seth Gilbert 和 Nancy Lynch 从理论上证明了猜想的可能性，从此，CAP 理论正式在学术上成为了分布式计算领域的公认定理。并深深的影响了分布式计算的发展。

CAP 理论告诉我们，一个分布式系统不可能同时满足一致性（C:Consistency)，可用性（A: Availability）和分区容错性（P：Partition tolerance）这三个基本需求，**最多只能同时满足其中的2个**。

| 选项 | 描述 |
| --- | --- |
| C（Consistence）| 一致性，指数据在多个副本之间能够保持一致的特性（严格的一致性，保证原子性）。 |
| A（Availability）| 可用性，指系统提供的服务必须一直处于可用的状态，每次请求都能获取到响应——但是不保证获取的数据为最新数据。 |
| P（Network partitioning）|  分区容错性，分布式系统在遇到任何网络分区故障的时候，仍然能够对外提供满足一致性和可用性的服务，除非整个网络环境都发生了故障。|

### 2、什么是分区？
在分布式系统中，不同的节点分布在不同的子网络中，由于一些特殊的原因，这些子节点之间出现了网络不通的状态，但他们的内部子网络是正常的。从而导致了整个系统的环境被切分成了若干个孤立的区域。这就是分区。

### 3、为什么只能 3 选 2

首先问，能不能同时满足这三个条件？
假设有一个系统如下：
![4236553-573b18642806420a.webp](https://pic.imgdb.cn/item/61cd7a8f2ab3f51d91bc6929.png)

整个系统由两个节点配合组成，之间通过网络通信，当节点 A 进行更新数据库操作的时候，需要同时更新节点 B 的数据库（这是一个原子的操作）。

上面这个系统怎么满足 CAP 呢？
C：当节点A更新的时候，节点B也要更新，
A：必须保证两个节点都是可用的，
P：当节点 A,B 出现了网络分区，必须保证对外可用。

可见，根本完成不了，只要出现了网络分区，A 就无法满足，因为节点 A 根本连接不上节点 B。如果强行满足 C 原子性，就必须停止服务运行，从而放弃可用性 C。

所以，最多满足两个条件：

### 4、组合分析结果
* CP	满足原子和分区容错，也就是说，要放弃可用。当系统被分区，为了保证原子性，必须放弃可用性，让服务停用。比如**银行项目**。
* AP	满足可用性和分区容错，当出现分区，同时为了保证可用性，必须让节点继续对外服务，这样必然导致失去原子性。比如一些**互联网项目**。
* CA	满足原子和可用，放弃分区容错。说白了，就是一个整体的应用(非分布式架构)。

**CAP理论3选2是伪命题，实际上必须从A和C选择一个和P组合**，更进一步基本上都会选择A，相比一致性，系统一旦不可用或不可靠都可能会造成整个站点崩溃，所以一般都会选择AP。但是不一致的问题也不能忽略，使用**最终一致是比较好的办法**。

### 5、能不能解决 3 选 2 的问题
CAP 理论已经提出了 13 年，也许可以做些改变。

仔细想想，分区是百分之百出现的吗？
如果不出现分区，那么就能够同时满足 CAP。如果出现了分区，可以根据策略进行调整。比如 C 不必使用那么强的一致性，可以先将数据存起来，稍后再更新，实现所谓的 “最终一致性”。

这个思路又是一个庞大的问题，同时也引出了第二个理论 Base 理论。
## 二、BASE 定理

BASE理论是对CAP中一致性和可用性权衡的结果，其来源于对大规模互联网系统分布式实践的总结， 是基于CAP定理逐步演化而来的。BASE理论的核心思想是：即使无法做到强一致性，但每个应用都可以根据自身业务特点，采用适当的方式来使系统达到最终一致性。
### 1、BASE中的三要素
* 基本可用（Basically Available）：基本可用是指分布式系统在出现不可预知故障的时候，允许损失部分可用性。注意，这绝不等价于系统不可用。比如：

  a)响应时间上的损失。正常情况下，一个在线搜索引擎需要在0.5秒之内返回给用户相应的查询结果，但由于出现故障，查询结果的响应时间增加了1~2秒
  
  b)系统功能上的损失：正常情况下，在一个电子商务网站上进行购物的时候，消费者几乎能够顺利完成每一笔订单，但是在一些节日大促购物高峰的时候，由于消费者的购物行为激增，为了保护购物系统的稳定性，部分消费者可能会被引导到一个降级页面。
* 软状态（Soft State）：软状态指允许系统中的数据存在中间状态，并认为该中间状态的存在不会影响系统的整体可用性，即允许系统在不同节点的数据副本之间进行数据同步的过程存在延时。
* 最终一致（Eventually Consistent）：最终一致性强调的是所有的数据副本，在经过一段时间的同步之后，最终都能够达到一个一致的状态。因此，最终一致性的本质是需要系统保证最终数据能够达到一致，而不需要实时保证系统数据的强一致性。

### 2、解放方案：
a）重试：
![erfgvzdsf.png](https://pic.imgdb.cn/item/61dcf2c62ab3f51d914c29d9.png)

b）数据校对程序：银行用的比较多
![dfswetewrewr.png](https://pic.imgdb.cn/item/61dcf42b2ab3f51d914d2b99.png)

c）人工介入
通过监控整个链接，如果中间出现异常，推送给人工处理。
![345y6hynbvcx.png](https://pic.imgdb.cn/item/61dcf4432ab3f51d914d3cd5.png)



