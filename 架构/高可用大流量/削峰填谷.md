## 削峰填谷-异步化
某些情况请求的数量不是均衡的，通常具有瞬时性，超过系统所能处理的请求，之后可能又突降，系统空闲资源多；就形成了基于系统负载能力上下的流量高峰低谷。显然这会造成系统的不稳定，甚至系统的雪崩，所以在系统架构设计的时候需要考虑这点。

比如秒杀业务，上游业务发起下单请求，下游业务执行秒杀业务（库存检查，库存冻结，余额冻结，生成订单等等），下游业务处理的逻辑是相当负载的，并发能力是有限的，如果上游服务不做限流策略，瞬时可能把下游服务压垮，甚至造成雪崩，服务不可用。


## 一、定义

* 削峰：为保证服务可用，剔除部分流量，业务有损 。
* 填谷：在服务能力盈余的情况下，提供补偿操作，业务补偿。

![v2-c5adc95861bbbbe7549eb5e9172d19a6_r.jpeg](https://pic.imgdb.cn/item/61e77bcd2ab3f51d91c67d90.jpg)

## 二、削峰方案
通过削去流量尖刺，让请求流量趋向平稳，以保障服务的稳定性。

### 1、客户端削峰

在后端的思维里面，削峰动作更多是服务端同学的工作和思考。但是在整体系统的设计中，客户端的削峰也是必不可少的。通过客户端的削峰，可以削减服务端的压力，从而保障系统的可用性。

##### 1.1 资源动静分离

这个方案比较简单，或者说目前基本都采用的方式。通过将静态资源与服务端隔离，在活动开始前，将资源预热到CDN，减轻服务端的压力。**客户端与服务端的交互，只有动态数据的交互。**

##### 1.2 请求削峰

a)设置两次请求最小有效时间间隔。
b)每个用户一次活动周期内有效请求设置一个概率。

### 2、服务端削峰
##### 2.1 限流削峰
服务端限流主要有 
* 网关限流
* 容器限流，比如负载均衡到多个服务器
* 服务器限流
  - 比如服务器限流中使用**Alibaba Sentinel**组件来做流量控制，但是是有损的。

##### 2.2 MQ削峰
在消息队列的架构中，有 pull 和 push 两种消息同步的方式，我们可以通过下游系统 订单系统 主动拉取`pull`的方式，来`保障下游服务`的流量稳定。

![v2-d65f4e98224b099b9545d192fab04b30_r.jpeg](https://pic.imgdb.cn/item/61e77d022ab3f51d91c78fd8.jpg)

那么，为什么用Pull模式?

Push模式下，下游服务是无法控制消息的，只能被动的接收，很可能处理不过来，但是又无法控制消息来的速率；所以可以采用主动Pull的模式，根据服务本身的处理能力，做流量控制。

那么，我们是否可以不用限流呢？ 答案是： 不能！

如果活动时间如果持续比较长，会产生消息堆积过多。 一方面会对消息中间件造成压力，另一方面，消息的有效性也没办法保障。

## 三、填谷方案
从上面的削峰策略可以看到，大部分的削峰 都是业务有损的。而在MQ削峰(无损)的场景下，我们可以通过将请求缓存的方式，减缓流量压力，由下游服务来控制请求压力，从而达到削峰的效果。

### 1、流程
* 在峰值流量阶段，将请求缓存，出现部分流量无法得到马上的处理。
* 通过峰值流量过去后，在消费能力盈余的情况下，对之前的请求做补偿操作，使整体流量趋向于平稳。
* 在用户可接受的时间范围内，获取自己的操作结果。同时对订单系统的负载做好保护。

![v2-bfdec04a0055bcc9b7b7af8072b5c5a8_r.jpeg](https://pic.imgdb.cn/item/61e77e182ab3f51d91c87893.jpg)

在这个过程要注意，要时刻监控消息队列的消息堆积，超过一定量的时候，增加消息处理机（水平扩容增加服务实例）。

进一步分析，可以把下游业务执行秒杀业务（库存检查，库存冻结，余额冻结，生成订单，积分，优化券服务等等）继续通过`消息中间件`解耦，提高核心业务`入库`的能力，提高`并发`。

### 2、消息队列的风险

在引入MQ中间件的同时，也会为我们带来以下的问题：
* 中间件可用性：MQ队列不可用，会导致整个链路不可用，严重会造成雪崩
* 消息可靠性：消息发送，消费需要得到保障
* 消息堆积：消息生产过快，导致MQ中间件压力过大
* 消息重复：消费幂等能力支撑
* 消息顺序：部分场景要求消费按照顺序执行







