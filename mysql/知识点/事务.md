## 事务
## 一、四大属性
 事务具有四个特征：原子性（ Atomicity ）、隔离性（ Isolation ）和持续性（ Durability ）、一致性（ Consistency ）。这四个特性简称为 ACID 特性。

## 二、原子性
事务是数据库的逻辑工作单位，事务中包含的各操作要么都做，要么都不做，也就是说事务是一个不可分割的整体，就像化学元素原子一样，最小的单位
> 通过undo log保证。

### 1 undo log是什么
Undo log 主要用于记录数据被修改之前的日志，在表信息修改之前先会把数据拷贝到undo log里。

当事务进行回滚时可以通过undo log 里的日志进行数据还原(记录了相反的操作)。

### 2 Undo log 的用途
* 保证事务进行rollback时的原子性和一致性，当事务进行回滚的时候可以用undo log的数据进行恢复。

* 用于MVCC快照读的数据，在MVCC多版本控制中，通过读取undo log的历史版本数据可以实现不同事务版本号都拥有自己独立的快照数据版本。

### 3 undo log主要分为两种：
* insert undo log
代表事务在insert新记录时产生的undo log , 只在事务回滚时需要，并且在事务提交后可以被`立即丢弃`。

* update undo log（主要）
事务在进行update或delete时产生的undo log; 不仅在事务回滚时需要，在快照读时也需要。

    所以不能随便删除，只有在快速读或事务回滚不涉及该日志时，对应的日志才会被purge线程统一清除。

## 三、隔离性
一个事务的执行不能被其它事务干扰。同一时间，只允许一个事务请求同一数据，不同事务之间彼此没有任何干扰
> 通过MVCC保证。

## 四、 持续性
也称永久性，指一个事务一旦提交，它对数据库中的数据的改变就应该是永久性的。接下来的其它操作或故障不应该对其执行结果有任何影响。 既事务完成后，事务对数据库的所有更新被保存到数据库，不能回滚。
> 通过redolog保证。

## 五、一致性
`上面三个属性一起保证一致性`。既事务开始前和结束后，数据库完整性约束没有被破坏；事务执行的结果必须是使数据库从一个一致性状态变到另一个一致性状态。因此当数据库只包含成功事务提交的结果时，就说数据库处于一致性状态。如果数据库系统 运行中发生故障，有些事务尚未完成就被迫中断，这些未完成事务对数据库所做的修改有一部分已写入物理数据库，这时数据库就处于一种不正确的状态，或者说是 不一致的状态。

### 2 事务回滚正确的理解
人们对事务的解释如下：事务由作为一个单独单元的一个或多个SQL语句组成，如果其中一个语句不能完成，整个单元就会回滚（撤销），所有影响到的数据将返回到事务开始以前的状态。因而，只有事务中的所有语句都成功地执行才能说这个事务被成功地执行。

如果事务中两条语句中的一条执行失败了，但如果以后在该连接中又执行了一条commit 或begin或start transaction（新开一个事务会将该链接中的其他未提交的事务提交，相当于commit！），即成功的那条语句被执行成功了。

所以事务回滚正确的理解应该是，如果事务中所有sql语句执行正确则需要自己手动提交commit；否则有任何一条执行错误，需要自己提交一条rollback，这时会回滚所有操作，而不是commit会给你自动判断和回滚。



