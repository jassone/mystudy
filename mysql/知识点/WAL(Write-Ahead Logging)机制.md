## WAL(Write-Ahead Logging)机制
## 一、简介
WAL 的全称是 Write-Ahead Logging，中文称`预写式日志`，是一种数据安全写入机制。就是先写日志，然后在写入磁盘，这样保证数据的安全性。Mysql中的Redo Log就是采用WAL机制。

## 二、WAL作用
Mysql中如果为了保证数据的持久性，在每提交一个事务就将日志刷新到磁盘上，这样效率就太低了，严重影响性能，所以就有了Write-Ahead 。
　　
## 三、Write-Ahead工作机制：
在内存中(buffer缓冲区)提交事务，然后再写日志(在InnoDB中就是Redo Log，日志是为了防止宕机导致内存数据丢失)，然后再后台任务中把内存中的数据异步刷到磁盘。

## 四、Write-Ahead工作流程

### redolog 两阶段提交
![8E4B0F07-0535-4F58-985B-7C13E606021A.png](https://pic.imgdb.cn/item/618fccba2ab3f51d916f9e73.png)
因为InnoDB和执行器是两套系统，所以日志必须要保持一致，否则会出现问题。

##### 先写redo log后写binlog：
* 假设在redo log写完，binlog还没写完时，Mysql进程异常重启。这时候，可以依靠redo log将数据恢复回来，假设恢复后这行数据自动c=1。
* 由于binlog没写完，这时候binlog里面就没有记录这个语句。 如果需要用这个binlog来恢复临时库的话，由于这个语句的binlog丢失，这个临时库就会少了这一次更新，恢复出来的行数据值c=0，与原库不同。

##### 先写binlog后写redo log：
假设在binlog写完后宕机，由于redo log还没写，重启mysql后这个事务无效，所以这行数据字段c=0。
但是binlog里面已经记录了“把c改为1”这个日志，所以之后用binlog来恢复的时候就多了一个事务出来，恢复出来的这行字段c=1,与原库不同。

## 四、WAL优缺点

优点：
* 在大多数情况下，WAL的速度要快得多。因为log日志是顺序读写，要比随机读写(正常磁盘读写)要快很多。

* WAL提供了更多的并发性，因为读卡器不会阻塞写卡器，而写卡器也不会阻塞读卡器。读和写可以同时进行。

* 使用WAL，磁盘I/O操作往往更为连续。

* WAL使用的fsync()操作更少，因此在fsync()系统调用中断的系统上不易受到问题的攻击。

缺点：　
* 一般情况下需要VFS支持共享内存模式(shared-memory primitives)。

* 操作数据库文件的进程必须在同一台主机上，不能用在网络操作系统。

* 持有多个数据库文件的数据库连接对于单个数据库时原子的，对于全部数据库是不原子的。

* 进入WAL模式以后不能修改page的size。

* 不能打开只读的WAL数据库(Read-Only Databases)，这进程必须有"-shm"文件的写权限。

* 对于只进行读操作，很少进行写操作的数据库，要慢那么1到2个百分点。

* 会有多余的"-wal"和"-shm"文件。

* 需要开发者注意checkpointing检查点。

 
## 问题
 ### 2 为什么redolog比正常数据库写磁盘快
* 因为普通数据写磁盘是随机的，会慢，但是log日志是追加模式的，是一种顺序IO。

* 还有就是buffer是数据页为单位的，大小为16K,一个数据页上一个小小的修改，都要把整个数据页写入。而redolog只需要写入真正需要的部分就可以了。无效的IO大大减少了。


https://www.jianshu.com/p/f242bc1e95ff