## 慎用多表关联
比如阿里开发规范里就要求静止三表关联。

### 1、原因分析
* mysql自身设计缺陷：超过3表关联时，mysql sql优化器做的不好。
* NLJ(Nested Loop Join 算法)多级嵌套性能差：mysql会先找小表，用小表去关联大表，这个过程中用到的贪心与动态规划算法计算量激增。
* 依赖数据源特性获取数据，数据迁移改造困难(比如某张表可能会被拆分出去分表等)。

### 2、解决方案
##### 第一种：单表单独查询(适用于小表情况)。

##### 第二种：反范式表
在业务表中增加几个需要关联查询的字段，数据冗余处理。
![20220110171907.jpg](https://pic.imgdb.cn/item/61dbfa192ab3f51d91b3e272.jpg)

##### 第三种：数据集市
比如银行系统，通过ETL对数据进行加工处理，生产中间表或者特定业务需求表，生产T+1的数据，业务方不再直接读取原始数据。

![20220110172230.jpg](https://pic.imgdb.cn/item/61dbfc0f2ab3f51d91b5ac61.jpg)

还可以生成`倒排表`，同一个订单id的订单详细数据都映射保持到同一个明细分片表
![20220110172817.jpg](https://pic.imgdb.cn/item/61dbfd632ab3f51d91b717c6.jpg)

### 3、关联查询注意
需要join的字段
* 数据类型要绝对一致
* 都要走到索引

### 4、用分解关联查询的好处
* 让缓存的效率更高。
* 许多应用程序可以方便地缓存单表查询对应的结果对象。另外对于MySQL的查询缓存来说，如果关联中的某个表发生了变化，那么就无法使用查询缓存了，而拆分后，如果某个表很少改变，那么基于该表的查询就可以重复利用查询缓存结果了。
* 将查询分解后，执行单个查询可以减少锁的竞争。
* 在应用层做关联，可以更容易对数据库进行拆分，更容易做到高性能和可扩展。
* 查询本身效率也可能会有所提升
* 可以减少冗余记录的查询。
* 更进一步，这样做相当于在应用中实现了哈希关联，而不是使用MySQL的嵌套环关联，某些场景哈希关联的效率更高很多。