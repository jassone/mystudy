## 上线部署发布
科学部署的意义* 尽可能减少服务停机时间* 控制新版本带来的质量风险

## 一、全量发布
### 1、 蓝绿部署
蓝绿部署是最常见的一种不需要停机的部署方式，是一种以可预测的方式发布应用的技术，目的是减少发布过程中服务停止的时间。

蓝绿发布的基本原理：
通常生产环境需要两组配置（蓝绿配置）:
* 一组是active的生产环境的配置（绿配置）.
* 一组是inactive的配置（绿配置）。

把负载均衡器／反向代理／路由指向蓝色环境了。随后需要监测新版本version2 是否有故障和异常。如果运行良好，就可以删除version1 使用的资源。如果运行出现了问题，可以通过负载均衡器指向快速回滚到绿色环境。

##### 优点：
* 发布策略简单；
* 用户无感知，平滑过渡；
* 升级/回滚速度快。

##### 缺点：
* 如果出问题，影响范围较大；
* 需要准备正常业务使用资源的两倍以上服务器，防止升级期间单组无法承载业务突发；
* 蓝绿发布需要有基础设施支持，基础设施无改动，增大升级稳定性。
* 当切换到蓝色环境时，需要妥当处理未完成的业务和新的业务。
* 有可能会出现需要同时处理“微服务架构应用”和“传统架构应用”的情况，如果在蓝绿部署中协调不好这两者，还是有可能导致服务停止；
* 需要提前考虑数据库与应用部署同步迁移/回滚的问题。
* 在非隔离基础架构（ VM 、 Docker 等）上执行蓝绿发布，蓝色环境和绿色环境有被摧毁的风险。
* 另外，这种方式不好的地方还在于冗余产生的额外维护、配置的成本，以及服务器本身运行的开销。

##### 适用的场景：
* 不停止老版本，额外搞一套新版本，等测试发现新版本OK后，删除老版本。
* 蓝绿发布是一种用于升级与更新的发布策略，部署的最小维度是容器，而发布的最小维度是应用。
* 蓝绿发布对于增量升级有比较好的支持，但是对于涉及数据表结构变更等等不可逆转的升级，并不完全合适用蓝绿发布来实现，需要结合一些业务的逻辑以及数据迁移与回滚的策略才可以完全满足需求。

### 2、红黑部署
与蓝绿部署类似，红黑部署也是通过两个集群完成软件版本的升级。当前提供服务的所有机器都运行在红色集群 Group1 中，当需要发布新版本的时候，具体流程是这样的：

* 先申请一个黑色集群 Group2 ，在 Group2 上部署新版本的服务；
* 等到 Group2 升级完成后，我们一次性地把负载均衡全部指向 Group2 ；
* 把 Group1 集群从负载均衡列表中删除，并释放集群 Group1 中所有机器。
 ##### 优点与蓝绿部署相比，红黑部署可以充分利用了云计算的弹性伸缩优势，从而获得了两个收益：
* 一是，简化了流程；
* 二是，避免了在升级的过程中，由于蓝绿发布于只有一半的服务器提供服务，而可能导致的系统过载问题。

##### 缺点
与蓝绿部署相比
* 发布过程中需要两倍的服务器资源。


## 二、增量发布
### 1、 灰度发布
灰度发布只升级部分服务，即让一部分用户继续用老版本，一部分用户开始用新版本，如果用户对新版本没什么意见，那么逐步扩大范围，把所有用户都迁移到新版本上面来。

灰度发布是通过切换线上并存版本之间的路由权重，逐步从一个版本切换为另一个版本的过程。

##### 灰度发布用户群的选择不能直接采用类似于Nginx的权重Weight，会导致一个用户不同请求在新旧版本间反复横跳，出现无法预期的Bug。
解决方法：利用Nginx + Lua脚本化基于IP或者UA等用户稳定特性然后Hash取模来决定访问新旧版本* Hash(192.168.31.102) % 10 = 7 #送给旧版本* Hash(192.168.31.108) % 10 = 9 #送给新版本

##### 什么时候才可以提升分配比例
在发布过程中，我们应该注意监测用户`请求失败率`、用户请求`处理时长`和`异常数量`这几个信息，以保证快速发现问题并及时回滚。在灰度发布的时候，可以部署相对较小的集群，让集群保持在高压力确认新版应用的性能情况，之后再酌情进行扩容。

##### 注意点：
* 考虑数据库变更对旧版本的兼容性影响。

##### 优点
* 保证整体系统稳定性，在初始灰度的时候就可以发现、调整问题，影响范围可控；
* 新功能逐步评估性能，稳定性和健康状况，如果出问题影响范围很小，相对用户体验也少；
* 用户无感知，平滑过渡。

##### 缺点
* 自动化要求高。## 三、滚动发布
滚动发布是指每次只升级一个或多个服务，升级完成后加入生产环境，不断执行这个过程，直到集群中的全部旧版本升级新版本。 

##### 优点
* 用户无感知，平滑过渡。
* 节约资源。

##### 缺点
* 部署时间慢，取决于每阶段更新时间；
* 发布策略较复杂；
* 无法确定OK的环境，不易回滚。
* 自动化要求高。

##### 部署过程
* 先升级1个副本，每次升级副本，自动从LB上摘掉，升级成功后自动加入集群。
* 事先需要有自动更新策略，分为若干次，每次数量/百分比可配置。
* 回滚是发布的逆过程，先从LB摘掉新版本，再升级老版本，这个过程一般时间比较长。

## 四、功能开关
这种发布方式是利用代码中的功能开关来控制发布逻辑，是一种相对比较低成本和简单的发布方式。

应用上线后，开关先不打开，只待一声令下，可以全量打开开关，也可以按照某种维度(公司ID，用户ID等)分批打开开关进行流量验证，如果有问题，则随时关闭开关。

##### 优点
* 升级切换和回退速度非常快。
* 成本较为低廉。

##### 缺点
* 就是开关本身也是代码，而且是与业务无关的代码，对代码的侵入性较高。
* 必须定期清理老版本的逻辑，使得维护成本增加。



