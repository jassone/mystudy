## 负载均衡

## 一、基础知识

### 1、什么是负载均衡

负载均衡是**高可用**网络基础架构的关键组件，通常用于将工作负载**分布到多个服务器**来提高网站、应用、数据库或其他服务的性能和可靠性。**支持故障发现与转移**。

### 2、负载均衡器可以处理什么样的请求？

**负载均衡器通常称为四层交换机或七层交换机。**

负载均衡器的管理员能主要为下面四种主要类型的请求设置转发规则：
* HTTP
* HTTPS
* TCP
* UDP

## 二、负载均衡分类

### 1、负载均衡的分类-软硬件

| 类型 | 说明 |  
| --- | --- | 
|  硬件| F5负载均衡器(**可扛百万QPS**) |  
|  软件| 四层代理（TCP）LVS(**可扛十万QPS**)，七层代理（HTTP）Nginx(**可扛一万QPS**)|  

### 2、负载均衡的分类-层级

##### a) 四层就是基于IP+端口的负载均衡

![74250.jpg](https://pic1.imgdb.cn/item/6400703bf144a01007b79b18.jpg)

四层通过虚拟IP+端口接收请求，然后再分配到真实的服务器。因此**TCP三次握手连接是与后端服务器直接建立起来的。**

四层交换机主要分析IP层及TCP/UDP层，实现四层流量负载均衡。主要分析IP层及TCP/UDP层，实现四层负载均衡。此种负载均衡器不理解应用协议（如HTTP/FTP/MySQL等等）。例子：LVS，F5。

具体实现：就是通过发布三层的IP地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行NAT处理，转发至后台服务器，并记录下这个TCP或者UDP的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。

简单说就是：在三层负载均衡的基础上，用 ip+port 接收请求，再转发到对应的机器。

- 优点：不对数据进行完全解析，不跟客户端建立连接（握手），请求分发的效率快。
- 缺点：无法灵活的进行转发，负载的服务器必须部署的相同服务器，否则同一个请求信息可能获取的结果是不同的。

##### b) 七层就是基于URL等应用层信息的负载均衡

![5760C3.png](https://pic1.imgdb.cn/item/64006ff6f144a01007b73db3.png)

七层通过虚拟的URL或主机名接收请求，然后再分配到真实的服务器。只能先与负载均衡设备进行TCP连接，**然后负载均衡设备再与后端服务器建立另外一条TCP连接通道**。因此，七层设备在网络性能损耗会更多一些。

七层交换机除了支持四层负载均衡以外，还有分析应用层的信息，如HTTP协议URI或Cookie信息。此时，该Load Balancer能理解应用协议。例子：  haproxy，MySQL Proxy，Nginx。 注意：上面的很多Load Balancer既可以做四层交换，也可以做七层交换。

具体实现：就是在四层的基础上，再考虑应用层的特征，比如同一个Web服务器的负载均衡，除了根据VIP加80端口辨别是否需要处理的流量，还可根据七层的URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的Web服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。

简单说就是：根据虚拟的url或是IP，主机名接收请求，再转向相应的处理服务器。

##### c) 四层代理和七层代理的优缺点
![20221230181126.jpg](https://pic.imgdb.cn/item/61cd86c22ab3f51d91c6ff44.jpg)

### 3、其他层级负载均衡

##### a) 基于MAC地址的二层负载均衡

一般是用虚拟mac地址方式，外部对虚拟MAC地址请求，负载均衡接收后分配后端实际的MAC地址响应

##### b) 基于IP地址的三层负载均衡

一般采用虚拟IP地址方式，外部对虚拟的ip地址请求，负载均衡接收后分配后端实际的IP地址响应

4、其他

todo
缓存代理：Twemproxy