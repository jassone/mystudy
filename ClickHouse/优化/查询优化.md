## 查询优化

## 一、高性能查询优化

### 1、选择合适的表引擎

### 2、建表时不要使用Nullable

因为存储Nullable列时需要创建一个额外的文件来存储Null的标记，并且Nullable列无法被索引。尽量用字段默认值。

### 3、合适的划分分区和索引

实际使用中，partition by基本是必须的。单分区数据最好不要超过100w行。建议按天分。

### 4、数据变更优化

官方建议一秒一次左右写入操作，每次写入数据2-5w。

### 5、使用Prewhere 代替 where

where的读取整行各个列的数据再进行过滤，而prewhere是先读取指令的列数据来判断数据过滤，符合条件后再读取select声明的列字段来补全查询，IO上有优势。prewhere只支持*MergeTree系列引擎。

默认情况下clickhouse会默认用prewhere代替where（内置优化）。

### 6、指定列和分区

避免用select *。

尽量在where条件后指定分区键的查询。

### 7、避免构建虚拟列

比如select A/B as rate form C。这时候可以将A/B是事先处理好后插入到一个真正的列中。

### 8、用in代替join

join操作机制是将后面表都加入到内存中，然后和前表数据在内存中进行合并。所以对内存消耗大。

如果非要用join，请用大表驱动小表。