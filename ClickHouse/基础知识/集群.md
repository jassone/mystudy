## 集群

clickhouse的**单机性能**通常已经非常优秀了，底层数据压缩效率也是很高的。一般够用了。

clickhouse集群分类：

- 数据副本，也就是将数据冗余到另外的机器上，用以保证高可用，
- 分布式表，将一个表数据分散到多个节点上保存。一般不需要，因为单机性能也够了。

## 一、数据副本

数据副本的目的是保证数据的高可用，当一台clickhouse宕机了，也可以从其他备份服务器获得相同的数据。

clickhouse集群没有主从之分，大家都是平等的。在**每台机器配置**了复制表后，在**任意一台机子**上insert以及alter操作后，会同步到其他的副本机器中。

这里的协调者是zookeeper。官方建议不要在clickhouse所在的服务器上运行zookeeper(因为其对数据延迟非常敏感)。

![20221228161251.jpg](https://pic.imgdb.cn/item/63abfaa208b68301639fb514.jpg)

- 数据副本需要经过网络传输，所以副本中写入数据是有延迟的。
- insert语句执行后，只会等待一个副本写入成功后就返回。
- 写入数据时，clickhouse只保证单个数据库的写入是原子的，而不能保证所有的数据写入是原子的。一个数据快(即分区？？？)的大小可以根据max_insert_block_size=1048576进行分快。
- 数据快写入时会去重。即一个同样的insert语句多次重复执行，数据库只会执行一次。这是为了防止用户重复插入数据或者网络波动等原因造成的数据重发。该机制只针对Replicated*MergeTree系列的表引擎。
- 某个副本节点宕机了，后续有重试机制。

## 二、分布式表

实际使用过程中，一般会配置副本来做高可用，通常不会做分片。

- 通过水平切分的方式，将完整的数据集切分成不同的分片，这些分片只保存一部分数据，分布在不同的节点上。然后再通过**Distributed表引擎(每个分布式表都有一个对应的)**将数据拼接起来作为一个完整的表使用。

- Distributed表引擎本身不存储数据，只是一个中间件而已，通过分布式逻辑表来写入，分发，路由操作多台节点不同分片的分布式数据。 但可以在多个服务器上进行分布式查询。

- 一个集群有多个分片shard，每个分片下可以配置一个或多个副本replica。这些replica副本可以配置成数据副本，或者分片表和数据副本表混合使用。声明分片表时需要指定一个集群。

  ![20221228174635.jpg](https://pic.imgdb.cn/item/63ac108708b6830163d404e9.jpg)

   internal_replications 可选的。是否只将数据写入其中一个正常的副本。默认值:false(将数据写入所有副本)。如果某个分片不可用时且又不是复制表，就丢失数据了。 建议如果分片内的子表都是复制表时，设置为true。如果设置为false，则这种机制不会检查副本的一致性，并且后面副本数据可能会不一致。

- 每个分片shard分配一个权重weight，可以选择在较好集群上权重大一点。

- 分布式表的数据是异步写入的。对于insert语句，数据块只写本地文件系统，之后会尽快在后台发送给远程服务器。如果这时机器节点丢失了，则会造成插入的数据丢失，不会再进行后续的检查。**而数据副本机制，会在机器故障恢复后，继续同步之前丢失的数据。**

- 读取：会把sql发送到每一个分片。

  ![20221228175747.jpg](https://pic.imgdb.cn/item/63ac135508b6830163d8a207.jpg)