## http长连接和短连接
## 一、以前的误解
那就是一直认为，HTTP连接分为长连接和短连接，而我们现在常用的都是HTTP1.1，因此我们用的都是长连接。

这句话其实只对了一半，我们现如今的HTTP协议，大部分都是1.1的，因此我们平时用的基本上都是长连接。但是前半句是不对的，HTTP协议根本没有长短连接这一说，也正因为误解了这个，导致对于长连接一直不明不白。

## 二、正解
由于HTTP在每次请求结束后都会主动释放连接，因此HTTP连接是一种“短连接”。

**HTTP协议是基于请求/响应模式的**，因此只要服务端给了响应，本次HTTP连接就结束了，或者更准确的说，是本次HTTP请求就结束了，根本没有长连接这一说。那么自然也就没有短连接这一说了。

之所以网络上说HTTP分为长连接和短连接，**其实本质上是说的TCP连接。TCP连接是一个双向的通道，它是可以保持一段时间不关闭的**，因此TCP连接才有真正的长连接和短连接这一说。

其实知道了以后，会觉得这很好理解。HTTP协议说到底是应用层的协议，而TCP才是真正的传输层协议，**只有负责传输的这一层才需要建立连接**。

因此，“HTTP连接”这个词就不应该出现，它只是一个应用层的协议，根本就没有所谓的连接这一说，就像FTP也是应用层的协议，但是你有听说过FTP连接吗？（其实所谓的FTP连接，严格来说，依旧是TCP连接）

实际上，**说HTTP请求和HTTP响应会更准确一些**，而HTTP请求和HTTP响应，都是通过TCP连接这个通道来回传输的。

现在用的基本上都是HTTP1.1协议，**HTTP1.1默认是长连接**。

### 1、浏览器并发使用问题
在HTTP1.1 版本中，HTTP连接在TCP连接中是有先后顺序的。意思是，比如有十个请求，不能并发的在一个TCP连接上发送。在一个TCP连接上，只能一个接一个发送。

浏览器是可以允许创建并发的TCP连接，比如Chrome 允许的是6个（并发TCP连接）。当页面后面还要有并发的TCP连接，那么该TCP连接将等待，浏览器会等前面的六个TCP连接中有结束的了，再调用新的TCP连接。

ConnectionID即为tcp连接id，相同表示用的是同一个tcp连接。
![20190620114944979.png](https://pic.imgdb.cn/item/620df9272ab3f51d91e85071.png)

### 2、TCP的keep alive和HTTP的Keep-alive的区别。
* TCP的keep alive是检查当前TCP连接是否活着；
* HTTP的Keep-alive是要让一个TCP连接活久点。

##### 表现
* TCP keep alive的表现：当一个连接“一段时间”没有数据通讯时，一方会发出一个心跳包（Keep Alive包），如果对方有回包则表明当前连接有效，继续监控。
* HTTP的Keep-alive中的Keep-alive：timeout =20就是TCP通道保持20秒。
 
## 三、HTTP长连接的优点和缺点
### 优点
长连接好处：比如你请求了一个网页，这个网页里还包含了CSS、JS等一系列资源，如果你是短连接，基本要建立几个甚至几十个TCP连接。但如果是长连接的话，客户端**再次访问这个服务器上的资源**，这么多次HTTP请求其实使用的都是一个TCP连接，很显然是可以节省很多消耗的。

### 缺点
长连接的状态下，一个Socket的存在时间是建立连接时间+ keepalive_timeout时间+ TIME_WAIT时间。那么如果在高并发的场景下，我们的Web服务器要同时保持大量的Socket连接，那么肯定是占用系统的资源。那么这个时候就要根据实际的情况来修改keepalive_timeout的值，直到一个合理的范围，那么这个需要根据自己的业务特点进行调整。

### 如何确定超时时间？
取决于Web应用的特点和具体需要。我可以给出一个生产实践的经验，那就是在大多数应用中应该是开启长连接，然后通过相关的测试，来确定长连接的超时时间，而不是使用网上文档写的某个时间。优化web,首先减少宽带传输，降低程序超时时间，提高访问效率。

## 四、配置使用
1. 客户端和服务端都需要设置Connection为keep-alive。
2. 服务端配置
    keepAliveTimeout(连接存活时间，超过这个时间那么需要再新建另一个连接)
    connection time-outMaxKeepAliveRequests表示一个连接最大支持的请求数。超过该请求数的连接也将被关闭（此时就会返回一个Connection: close头给客户端）
     timeout(浏览器和服务器连接的超时时间，超过这个时间服务器就会和浏览器断开)。
     