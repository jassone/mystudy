## 一致性哈希算法
说明：当前文章提到的节点是用服务器来举例的。

## 一、普通哈希算法的问题
算法：计算key的hash值，然后对节点数量进行取余，从而决定数据映射到哪个节点上。

当缓存服务器数量发生变化时，几乎所有缓存的位置都会发生改变，会引起缓存的雪崩，可能会引起整体系统压力过大而崩溃（大量缓存同一时间失效）。

## 二、一致性哈希算法
### 1、原理
一致性哈希算法将整个哈希值空间组织成一个虚拟的圆环，如下图所示，范围为0-2^32-1 (key对2^32 取模)；对于每个数据，根据key计算hash值，确定数据在环上的位置，然后从此位置沿环顺时针行走， 找到的第一台服务器(比如服务器地址对2^32取模)就是其应该映射到的服务器。

![1174710-20181025213424713-1246878063.png](https://pic.imgdb.cn/item/610f546f5132923bf8d4e38a.png)

### 2、一致性哈希算法优点
与普通哈希算法相比，**一致性哈希分区将增减节点的影响限制在相邻节点**。以上图为例，如果在node1和node2之间增加node5，则只有node2中的一部分数据会迁移到node5；如果去掉node2，则原node2中的数据只会迁移到node4中，只有node4会受影响。

### 3、一致性哈希算法缺点---哈希环偏斜
* 当节点数量较少时，节点在环上分布的可能不均匀，导致某些服务器负载很大，可能缓存雪崩。
* **当节点数量较少时，增加或删减节点，对单个节点的影响可能很大，造成数据的严重不平衡**。还是以上图为例，如果去掉node2，node4中的数据由总数据的1/4左右变为1/2左右，与其他节点相比负载过高。

## 三、一致性哈希算法优化-虚拟节点
### 1、原理
将现有的物理节点通过虚拟的方法复制出来，这些由实际节点虚拟复制而来的节点被称为”虚拟节点”。

比如我们有3台服务器，可以扩充为
* 服务器1-1，服务器1-2，服务器1-3。。。
* 服务器2-1，服务器2-2，服务器2-3。。。
* 服务器3-1，服务器3-2，服务器3-3。。。

**这样环上的虚拟节点越多，hash环上的节点就越多，缓存被均匀分布的概率就越大。**

## 四、一致性哈希实际应用场景
* **redis分区时一致性哈希虚拟节点的槽（slot）**。
* **负载均衡系统**。
