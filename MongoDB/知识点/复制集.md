## 复制集

## 一、基础知识

复制集作用：**实现高可用**

### 1、特点

- 在数据写入时将数据复制到另外一个独立节点上
- 在接受写入节点发生故障时自动选举重一个新的替代节点

### 2、好处

- 数据分发：将数据从一个区域复制到另外一个区域，减少另外一个区域的读延迟
- 读写分离: 不同类型的压力分别在不同的节点上执行
- 异地容灾：在数据中心故障时快速切换到异地

### 3、细节

典型复制集由3个以上具有投票权的节点组成：一个主节点(负责写)和二个从节点(复制主节点的新数据)

- 当一个修改操作到达主节点时，它对数据的操作会被记录下来，这些记录成为oplog
- 从节点通过在主节点上打开一个游标不断获取新进入主节点的oplog，并在自己的节点上回放，以此来保持跟主节点的数据一致
- 复制集同步时间很快，局域网内基本几个毫秒就能完成，最多10毫秒

### 4、选举

1 具有投票权的节点之间两两互相发送心跳
2 当5次心跳未收到时判断为节点失联
3 如果失联的主节点，从节点会发起选举，选举出新的主节点
4 如果失联的是从节点，则不会产生新的选举
5 选举基于RAFT一致性算法，选举成功的必要条件是大多数投票节点存活
6 **复制集中最多可以有50个节点，但具有投票权的节点最多7个**

##### 影响选举的因素

1 整个集群必须有大多数节点存活，比如7个节点，必选有4个，5个必选有3个
2 被选举为主节点必须要求
 a:能够与多数节点建立连接
 b:具有较新的oplog
 c: 具有较高的优先级（如果有配置）

## 二、相关问题

### 1、如何解决刚插入的一条数据，在从节点上能读取到？

- 写到时候，writeConcern：majority
- 读的时候 ，readpref: secondary + readConcern：majority

