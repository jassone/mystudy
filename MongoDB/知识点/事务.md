## 事务



### 事务的隔离级别

- 事务完成前，事务内外都不可访问对方修改的数据。

- 如果事务内使用readConcern:snapshot，则可以达到可重复读Repeatable Read的效果。？ Todo



### 事务写机制

MongoDB的事务错误处理机制不同于关系型数据库

- 当一个事务开始后，如果事务要修改的文档在事务外部被修改过，则事务修改这个文档时会出发Abort错误，因为此时修改冲突了，这种情况下，只需要简单的重做事务就可以了
- 如果一个事务已经开始修改一个文档，在事务以外尝试修改同一个文档，则事务以外的修改会等待事务完成才能继续进行



### 注意事项

- 可以实现和关系型数据库类似的事务场景
- 必须使用与MongoDB4.2兼容的驱动
- 事务默认必须在60s（可调）内完成，否则将被取消
- 涉及事务的分片不能使用仲裁节点
- 事务会影响chunk迁移效率。正在迁移的chunk也可能造成事务提交失败（重试即可）
- 多文档事务中的读操作必须使用主节点读
- readConcern只应该在事务级别设置，不能设置在每次读写操作上

## 相关wili

- MongoDB的事务处理 https://www.cnblogs.com/xiaoqingtian/p/13510898.html 