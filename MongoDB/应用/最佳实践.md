## 最佳实践

## 一、连接配置

- maxPoolSize: 连接池大小
- Max Wait Time 建议设置，自动杀掉太慢的查询
- Write Concern : 建议majority，保证数据安全
- Read Concern : 对于数据一致性要求高的场景适当使用

### 1、连接字符串节点和地址

- 无论对于复制集或分片集，连接字符串中都应尽可能多提供节点地址，建议全部列出

  a) 复制集利用这些地址可以更有效地发现集群成员

  b）分片集利用这些地址可以更有效地分散负载

- 连接字符串中尽可能使用与复制集内部配置相同的域名或IP

### 2、使用域名连接集群

使用域名可以为集群变更时提供一层额外保护。比如将集群迁移到新网段，直接修改域名解析即可。

另外mongodb+srv://协议可以提供额外一层的保护。

## 二、其他

### 1、在mongodb前是否需要使用负载均衡

不建议在mongos或者复制集上层放置负载均衡器，而是应该让驱动出来负载均衡和自动故障恢复。

- 驱动会无法探测具体哪个节点存活，从而无法完成自动故障恢复。
- 驱动会无法判断游标是在哪个节点创建的，从而便利游标时出错。

### 2、游标使用

如果一个游标已经变量完，则会自动关闭，如果没有变量完，则需要手动调用close()方法，否则该游标将这才服务器上存活10分钟(默认值)后超时释放，造成不必要的浪费。

但是如果不能遍历完一个游标，通常意味着查询条件太宽泛，更应该考虑的问题是如何将条件收紧。

### 3、查询

- 每一个查询尽量走到索引，一个慢查询会影响到其他查询

### 4、写入

- 尽可能使用批量插入，效率提升很大

### 5、文档结构

- 防止使用太深的数组嵌套，不超过2层

### 6、其他

- 使用TTL来设置文档自动过期

### 7、事务

- 尽量少用事务，在模型设计上规避事务。
- 使用事务时，尽可能让涉及事务的文档分布在同一个分片上，这将有效提高效率。

## 三、扩展应用

spark+mongodb



