## nginx工作模式

## 一、nginx的工作模式

###  1、master-worker模式

![2a4e-f081-11ec-8b7a-fa163eb4f6be.png](https://pic.imgdb.cn/item/62d7b471f54cd3f9379202ea.png)

![a58392ddae3_r.jpeg](https://pic.imgdb.cn/item/62d7b847f54cd3f937a67ea4.jpg)

![11ec-8b7a-fa163eb4f6be.png](https://pic.imgdb.cn/item/62d7b702f54cd3f9379fd71c.png)

nginx启动成功后，会有一个master进程和至少一个worker进程。

##### a) master进程

- 以root用户身份运行。

主要作用：

- 读取并验证配置信息；
- 创建、绑定及关闭套接字，绑定端口；
- 启动、终止及维护worker进程的个数；
- 无须中止服务而重新配置工作特性；
- 控制非中断式程序升级，启用新的二进制程序并在需要时回滚至老版本；
- 重新打开日志文件；
- 编译嵌入式perl脚本；

##### b) worker进程

- 以非特权用户身份运行。

- 对于外部来说，真正提供服务的是worker进程。

- **每一个Worker进程都仅维护一个线程（避免线程切换）并独立运行，处理连接和请求**；并主要通过“共享内存”的机制实现进程间通信。

- **Worker进程的个数由配置文件决定，一般和CPU个数相关（有利于进程切换），配置几个就有几个Worker进程。**

  如果负载以CPU密集型应用为主，如SSL或压缩应用，则worker数应与CPU数相同；如果负载以IO密集型为主，如响应大量内容给客户端，则worker数应该为CPU个数的1.5或2倍

主要作用：

- 接收、传入并处理来自客户端的连接，与上游服务器通信；
- 提供反向代理及过滤功能；
- nginx任何能完成的其它任务；

##### c) 还有一些其他的进程一块工作：

- cache manager 子进程，周期性运作，并且会控制磁盘缓存的进入来保持缓存在配置的大小范围内。
- Cache Loader 子进程，在启动的时候就会运行，会把存在磁盘的缓存加载到内存中，然后退出。这个子进程被谨慎地排定，所以它的资源需求很低。

##### d) 优点：

- 稳定性高：一个worker进程挂掉后master进程会立即启动一个新的worker进程，保证worker进程数量不变，降低服务中断的概率；
- 配合linux的cpu的亲和性的匹配中，可以充分利用多核cpu的优势，提升性能；
- 处理信号、配置重新加载等可以做到尽可能不中断服务；

### 2、单进程模式

![20210531105934710.png](https://pic.imgdb.cn/item/62d7adfaf54cd3f9376fab94.png)

nginx只有一个进程，nginx所有工作都由这个进程负责

##### a) 优点：可以很方便的利用gdb工具进行调试

##### b) 缺点：

- 不支持平滑升级
- 任何的信号处理都可能造成服务中断
- 进程挂掉后，在没有外部监控的情况下，无法重启服务
- 生产环境中不会使用