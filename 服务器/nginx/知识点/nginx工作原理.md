## nginx工作原理

nginx的主要着眼点就是其高性能以及对物理计算资源的高密度利用，因此其采用了不同的架构模型。**受启发于多种操作系统设计中基于“事件”的高级处理机制，nginx采用了模块化、事件驱动、异步、单线程及非阻塞的架构，并大量采用了多路复用及事件通知机制。**在nginx中，连接请求由为数不多的几个仅包含一个线程的进程worker以高效的回环(run-loop)机制进行处理，而**每个worker可以并行处理数千个的并发连接及请求**。

在nginx内部，进程间的通信是通过模块的pipeline或chain实现的；换句话说，**每一个功能或操作都由一个模块来实现。**例如，压缩、通过FastCGI或uwsgi协议与upstream服务器通信，以及与memcached建立会话等。

## 一、nginx工作原理

### 1、nginx采用异步非阻塞的工作方式

**Nginx采用了Linux的epoll模型，epoll模型基于事件驱动机制，它可以监控多个事件是否准备完毕，如果ok，那么放入epoll队列中，这个过程是异步的。worker只需要从epoll队列循环处理即可。**

**nginx配置use epoll后，以异步非阻塞方式工作，这就是nignx的高并发的原理。**

### 2、处理过程：

每进来一个请求，会由一个工作进程去处理，但不是全程进行处理，处理可能会发生阻塞的情况

比如：向后端服务器转发请求，那么这个处理的工作进程不会一直等待，它会在发送完请求后，注册一个事件等待后端服务器返回；

此时，再有新的请求，这个worker就很快按照这个方式处理；

而一旦后端服务器返回信息，就会触发这个事件，worker就会进行处理，这个请求才会接着往下走；

通过这种<快速处理并快速释放请求>的方式，达到同样的配置可以处理更大并发的目的。

## 二、其他

### 1、热部署原理

修改配置文件nginx.conf后，重新生成新的worker进程，当然会以新的配置进行处理请求，而且新的请求必须都交给新的worker进程，至于老的worker进程，等把那些以前的请求处理完毕后，kill掉即可。

### 2、高并发原理

Nginx能够处理高并发的原因在于**对socket的管理方式是异步非阻塞的**，使用epoll来实现对大量socket描述符的管理，每个worker进程有一个主线程，而没有其他的线程，这样的好处就在于不需要进行线程间的切换，这样就节省了资源。

所以总的来说：Nginx能够实现支持高并发的同时运行效率还很低的关键在于：

- 整个系统内部只有有限的几个工作进程和一个监听进程，而每个进程内部只有一个主线程，这样就不会引起很多的线程切换，从而降低了系统开销，
- 同时每个线程内部使用异步非阻塞的方式来管理描述符，这样就可以管理大量的描述符，当描述符多的时候也只是会占用较多的内存而已，而不会造成占用大量cpu时间。